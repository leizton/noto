{"lines":[{"id":"327CC7BD-1AD3-451D-B235-61A291E97BF4","content":"输入输出流\n","styles":[],"paragraphType":"title","attachments":[]},{"id":"070D2FFF-4B8B-4489-9C21-D2EB29663F6D","content":"\n","styles":[],"paragraphType":"body","attachments":[]},{"id":"DB6EFFC8-C09E-4A2D-A212-00BF4CB38FB6","content":"￼\n","styles":[],"paragraphType":"body","attachments":[{"percentageWidth":1,"content":"http:\/\/kaiyuan.me\/2017\/06\/22\/custom-streambuf\/","type":"link","name":"FC46F5E9-132D-402F-974C-218464B3030A","location":0}]},{"id":"E28E1779-4D68-452A-BA80-63C01F32DA69","content":"\n","styles":[],"attachments":[]},{"id":"E774D6CF-5F62-48F3-862B-F417E2BAF33E","content":"\n","styles":[],"attachments":[]},{"id":"EC54BCA8-3C5C-458B-8C53-E9C7F4682E6D","content":"## 继承关系\n","styles":[],"attachments":[]},{"id":"04F0546E-4537-4C5F-B3E0-5EF4AA83D8A1","content":"ios_base — ios — istream ostream — iostream — fstream stringstream\n","styles":[],"attachments":[]},{"id":"9744FBC2-77B6-4C7D-91BB-099407AE5E8B","content":"istream — ifstream istringstream cin\n","styles":[{"type":"highlight","range":[0,7],"color":"#50b6ff"}],"attachments":[]},{"id":"E6F63DC1-E9DD-4534-8973-84E625FCA918","content":"ostream — ofstream ostringstream cout cerr\n","styles":[{"type":"highlight","range":[0,7],"color":"#50b6ff"}],"attachments":[]},{"id":"4D375271-558B-4646-ACE8-39DF6E70F877","content":"streambuf — filebuf stringbuf\n","styles":[{"type":"highlight","range":[0,9],"color":"#50b6ff"}],"attachments":[]},{"id":"F8CC57F3-C25A-407C-B0DB-270FB4876ED1","content":"\n","styles":[],"attachments":[]},{"id":"0049BCEE-A4D5-43FC-BFE9-0D0D9C3C60CF","content":"\n","styles":[],"attachments":[]},{"id":"EBA313A1-63CD-4E58-A914-1089BE615506","content":"## streambuf\n","styles":[],"attachments":[]},{"id":"F02D2F1A-701A-416F-A0D0-033BAA23DC04","content":"##### 源码\n","styles":[],"attachments":[]},{"id":"8FDD5BEB-1A39-4614-8C92-454103AD377A","content":"streambuf.cc\n","styles":[],"attachments":[]},{"id":"A01F8CFE-B7AF-4302-976F-BCB519204D71","content":"##### 声明\n","styles":[],"attachments":[]},{"id":"CC3F7C8E-3C06-4AD9-83A4-2205606E7DB3","content":"template<class Char, class Traits=std::char_traits<Char>> class basic_streambuf;\n","styles":[{"type":"highlight","range":[64,79],"color":"#50b6ff"}],"attachments":[]},{"id":"27A8B5A1-9BEB-4CDC-97FD-7CA81A1B42C0","content":"typedef basic_streambuf<char> streambuf;\n","styles":[{"type":"highlight","range":[30,39],"color":"#50b6ff"}],"attachments":[]},{"id":"539AAF9B-B15D-4EED-8FCE-EB523A7E76A5","content":"#### 内部结构\n","styles":[],"attachments":[]},{"id":"C9DB6E57-101C-4DB3-B57C-5747D032AE1D","content":"用作输出时，3个指针接口：pbase(buf头指针, 指向buf第一个字节)  epptr(buf尾指针)  pptr(第一个可写位置)\n","styles":[{"type":"highlight","range":[13,18],"color":"#66c6c2"},{"type":"highlight","range":[40,45],"color":"#66c6c2"},{"type":"highlight","range":[55,59],"color":"#66c6c2"}],"attachments":[]},{"id":"040E9843-DAAF-4F79-BCE8-E451152B9923","content":"\tpbase ~ pptr是已写内容，pptr ~ epptr是可写区间\n","styles":[],"attachments":[]},{"id":"2815B5CA-08D7-4D91-9984-9D9B1D803417","content":"用作输入时，3个指针接口：eback(buf头指针)  egptr(buf尾指针)  gptr(第一个可读位置)\n","styles":[{"type":"highlight","range":[43,47],"color":"#66c6c2"},{"type":"highlight","range":[28,33],"color":"#66c6c2"},{"type":"highlight","range":[13,18],"color":"#66c6c2"}],"attachments":[]},{"id":"8B707F36-9DBB-4FAF-8CCA-E1546FE57E81","content":"\tgptr ~ egptr是可读内容\n","styles":[],"attachments":[]},{"id":"607A5535-651F-466B-9595-8F69CBA6E13F","content":"#### 写功能\n","styles":[],"attachments":[]},{"id":"B03CA958-BA34-4236-8D20-07C53579DEB3","content":"•\tsputc(Char c):int\n","styles":[{"type":"highlight","range":[2,7],"color":"#f5685b"}],"attachments":[]},{"id":"03FD8095-6D45-4E0B-9EBB-374191F0572C","content":"\t\t*(pptr++)=c\n","styles":[],"attachments":[]},{"id":"3F183E77-84A5-4C33-9AAA-62804479BB8B","content":"\t\t当没有可写空间时，调用overflow(c)\n","styles":[],"attachments":[]},{"id":"9FEDFE42-ED2F-4A3F-9CB8-20A8AE8333F3","content":"\t\t返回Traits::eof()，表示写失败\n","styles":[],"attachments":[]},{"id":"F3580BAE-9678-4EC3-B97C-9F92FD8E7FB7","content":"•\tsputn(const Char* s, size_t num):size_t\n","styles":[{"type":"highlight","range":[2,7],"color":"#f5685b"}],"attachments":[]},{"id":"1A4CA7A2-65F7-47EE-A1B7-ECC1A1B57A15","content":"\t\t\/\/ 一次写多个，例如：\n","styles":[],"attachments":[]},{"id":"B0887BAD-27EB-4F47-B88F-26CFE88C6656","content":"\t\tostringstream oss\n","styles":[],"attachments":[]},{"id":"D52B8728-FC51-4F5F-B00E-EE366B812BF5","content":"\t\toss.rdbuf()->sputn(\"abcd\", 3) == 3\n","styles":[],"attachments":[]},{"id":"CECB6363-5445-4FA2-B65D-9299F9E5EF86","content":"\t\tistringstream iss\n","styles":[],"attachments":[]},{"id":"311998F0-B270-4F9E-9F19-69DEB614491D","content":"\t\tiss.rdbuf()->sputn(\"abcd\", 3) == 0\n","styles":[],"attachments":[]},{"id":"3E0C74D0-758A-48EF-8337-9579EF6F84A9","content":"#### 读功能\n","styles":[],"attachments":[]},{"id":"9D3431F0-5263-4161-808B-4C23EEB8E6FD","content":"•\tsgetc():int  { return *gptr }\n","styles":[],"attachments":[]},{"id":"50D0DA01-6228-4A95-844F-F50687183B52","content":"•\tsgetn(Char* s, size_t num):size_t\n","styles":[],"attachments":[]},{"id":"1B600567-2AB1-45F9-A281-DE9C9AB1D5ED","content":"•\tsbump():int { return *(gptr++) }\n","styles":[],"attachments":[]},{"id":"78504162-4AB8-49BF-94D7-6D1132028C09","content":"•\tsungetc() { gptr-- }\n","styles":[],"attachments":[]},{"id":"3AE2A5EF-FA0F-490F-A064-DDC66A03EDB8","content":"•\tsputbackc(int c) { *(--gptr) = c }\n","styles":[],"attachments":[]},{"id":"EF5A36F2-E1C2-468F-9132-0E3A043481A8","content":"#### 操作内置指针\n","styles":[],"attachments":[]},{"id":"DFF08E98-D4E9-43FF-9401-CE4B5C285881","content":"•\tsetp(Char* pbase, epptr)\n","styles":[{"type":"highlight","range":[2,6],"color":"#f5685b"}],"attachments":[]},{"id":"1F17AC05-18AF-4CBB-922A-F40736B68D35","content":"•\tpbump(int move) { pptr += move }\n","styles":[{"type":"highlight","range":[2,7],"color":"#f5685b"}],"attachments":[]},{"id":"6161A4FF-7772-4B43-AFAE-278FDB887551","content":"•\tsetg(Char* eback, gptr, egptr)\n","styles":[{"type":"highlight","range":[2,6],"color":"#f5685b"}],"attachments":[]},{"id":"0D10091A-E151-4D59-A472-0B5AC1FD0D43","content":"\n","styles":[],"attachments":[]},{"id":"DC2F15C2-7DC5-4813-BEC3-E36F2A503082","content":"\n","styles":[],"attachments":[]},{"id":"7EE0AAC1-5844-4081-8517-E2A0802F6634","content":"## 自定义用于输出的streambuf\n","styles":[],"attachments":[]},{"id":"826AB46F-15E1-4A10-85B1-812C9B313ED4","content":"class TcpOutStreamBuf : public streambuf {\n","styles":[{"type":"highlight","range":[6,21],"color":"#50b6ff"}],"attachments":[]},{"id":"7E0F083D-8D37-45A9-BAB9-B5903A4976D2","content":"private:\n","styles":[],"attachments":[]},{"id":"3E5A9EDD-4329-458F-B712-28FB25393F4D","content":"\tint sock_\n","styles":[],"attachments":[]},{"id":"8EB52260-B4FE-45DA-BFAB-65A7F319A465","content":"\tchar buf_[1024]\n","styles":[],"attachments":[]},{"id":"46A6DD98-D1F0-45B3-A932-4CC7A5A74715","content":"public:\n","styles":[],"attachments":[]},{"id":"4010E0BC-B13D-4467-96C5-941CF3ACE907","content":"\tTcpOutStreamBuf(int sock) : sock_(sock) {\n","styles":[],"attachments":[]},{"id":"E47685D5-11E7-4EC9-9778-28754E50D1D0","content":"\t\t\/\/ 设置streambuf 内部的buf\n","styles":[],"attachments":[]},{"id":"41969BBE-25DD-457F-A70B-749579352258","content":"\t\tsetp(buf_,  buf_ + 1024)\n","styles":[{"type":"highlight","range":[2,6],"color":"#fa9757"}],"attachments":[]},{"id":"E0969143-A68C-43CB-A3F6-3C525C10F0B7","content":"\t}\n","styles":[],"attachments":[]},{"id":"2D80A6A9-3509-47E0-8461-D8B16B415188","content":"\toverride int sync() {  \/\/ 被overflow调用\n","styles":[{"type":"highlight","range":[1,18],"color":"#f5685b"}],"attachments":[]},{"id":"9D6A4BE2-7591-447D-976F-B4AFF019273C","content":"\t\tconst int total = pptr() - pbase()  \/\/ 可发送总量\n","styles":[],"attachments":[]},{"id":"11B0863A-36E2-480A-864C-B82F4E236AE2","content":"\t\tif (total == 0) return 0\n","styles":[],"attachments":[]},{"id":"EAB928CF-D2A1-4EE2-81A5-47CCCE0243F5","content":"\t\tint sent = 0  \/\/ 已发送量\n","styles":[],"attachments":[]},{"id":"1DA51C97-D369-48C6-9B4D-B290F32BDC5C","content":"\t\twhile (sent < total)\n","styles":[],"attachments":[]},{"id":"DA133FAF-8FE9-4802-B530-42EBDAC20FDF","content":"\t\t\tint n = ::send(sock_, pbase()+sent, total-sent, 0)\n","styles":[],"attachments":[]},{"id":"98979CC2-580F-41F3-B813-A387D12D998C","content":"\t\t\tif (n <= 0) break\n","styles":[],"attachments":[]},{"id":"0C2BBEFB-5A29-4DBC-BBCF-B0076678BF03","content":"\t\t\tsent += n\n","styles":[],"attachments":[]},{"id":"670AB4C5-2E2C-488F-8D54-6B62FAEAE6CE","content":"\t\tleft = total - sent\n","styles":[],"attachments":[]},{"id":"33D5C540-D126-4798-A4FD-15B679BED118","content":"\t\tif (left > 0)\n","styles":[],"attachments":[]},{"id":"FDD2DCA2-1DF8-46E2-A7F6-2DB075101B0B","content":"\t\t\tcopy [pbase+sent, pptr) to [pbase, pbase+left)\n","styles":[],"attachments":[]},{"id":"CB6CFA7D-F863-4217-A55C-6573F83673D6","content":"\t\tpbump(-sent)\n","styles":[{"type":"highlight","range":[2,7],"color":"#fa9757"}],"attachments":[]},{"id":"E0A9871B-04FA-4172-9D52-B72970719845","content":"\t\treturn sent > 0 ? 0 : -1  \/\/ 一个字节都没发出去，标记成fail\n","styles":[],"attachments":[]},{"id":"7BD4BE0F-1837-4BE9-80B1-91154E51CB4C","content":"\t}\n","styles":[],"attachments":[]},{"id":"A241C3E6-6368-4958-B1EA-8E8F35932FD9","content":"\toverride int overflow(int c) {\n","styles":[{"type":"highlight","range":[1,22],"color":"#f5685b"}],"attachments":[]},{"id":"CA12E956-EEEB-4C23-970D-6C7FF4B46257","content":"\t\t\/\/ 缓冲区没有可写空间时，overflow被调用\n","styles":[],"attachments":[]},{"id":"058330DE-B27B-4873-B497-E8FB259ED836","content":"\t\tif sync()，return traits_type::eof()  \/\/ 写通道已关闭\n","styles":[{"type":"highlight","range":[5,9],"color":"#fa9757"}],"attachments":[]},{"id":"693313EA-8260-4A3C-ACA5-2038F23D82CF","content":"\t\tsputc(c)\n","styles":[],"attachments":[]},{"id":"36638503-02B1-4684-A7C6-353ABC2B58D6","content":"\t\treturn c\n","styles":[],"attachments":[]},{"id":"83B04973-B74C-4CA1-BD67-B7E87B5F9C64","content":"\t}\n","styles":[],"attachments":[]},{"id":"FFBA2B47-6395-436A-BC85-EE5E479CA7EE","content":"}\n","styles":[],"attachments":[]},{"id":"5517B6A7-9CB0-48DA-A0FF-9E244A7EBB18","content":"\n","styles":[],"attachments":[]},{"id":"10B84706-F91A-482F-8CA2-7F017FFBE46B","content":"\n","styles":[],"attachments":[]},{"id":"C852384E-3774-4354-B3E6-79A7F61483F3","content":"## 自定义用于输入的streambuf\n","styles":[],"attachments":[]},{"id":"E4866927-ED9F-4208-9F07-0A9FF66BE290","content":"当gptr == egptr时，没有可读内容，sgetc会调用underflow从外部读入内容到buf\n","styles":[],"attachments":[]},{"id":"32C8E475-E5DD-4EDF-BBDD-AFDE6C49B156","content":"class TcpInStreamBuf {\n","styles":[{"type":"highlight","range":[6,20],"color":"#50b6ff"}],"attachments":[]},{"id":"A6CE1C15-DF49-45A9-80C3-6E21EB741042","content":"public:\n","styles":[],"attachments":[]},{"id":"29DC423F-190C-4078-83E8-7CAB3CBDC545","content":"\tTcpInStreamBuf(int sock, size_t buf_size) : sock_(sock), buf_size_(buf_size) {\n","styles":[],"attachments":[]},{"id":"776A76AF-2E0A-4576-A36B-AC874D6D84EC","content":"\t\tsetg(buf_, buf_, buf_)\n","styles":[{"type":"highlight","range":[2,6],"color":"#fa9757"}],"attachments":[]},{"id":"58D236B7-ED62-4871-BE0C-8CA0205A01C0","content":"\t}\n","styles":[],"attachments":[]},{"id":"125C154A-815E-4709-A7BE-C79F573DE9D4","content":"\toverride int underflow() {\n","styles":[{"type":"highlight","range":[14,23],"color":"#f5685b"},{"type":"highlight","range":[1,14],"color":"#f5685b"}],"attachments":[]},{"id":"E7D21A54-5CD7-4702-8AD9-4E7D2DEC068B","content":"\t\tint n = ::recv(sock_, buf_, buf_size_, 0)\n","styles":[],"attachments":[]},{"id":"E586C8FA-CE35-4AA5-8A62-E0741761C282","content":"\t\tif (n > 0)\n","styles":[],"attachments":[]},{"id":"DB7F9A2B-20C4-406C-843F-8C149848AB22","content":"\t\t\tsetg(buf_, buf_, buf_+n)\n","styles":[],"attachments":[]},{"id":"EBA4D963-31EA-450F-89C2-32BB08A36172","content":"\t\t\treturn traits_type::to_int_type(*gptr())\n","styles":[],"attachments":[]},{"id":"6A5ED3D8-7D82-4A97-A96F-0AD024CA7F33","content":"\t\telse\n","styles":[],"attachments":[]},{"id":"737B217C-7F3C-4784-AFFD-1429F5714F7C","content":"\t\t\treturn traits_type::eof()\n","styles":[],"attachments":[]},{"id":"5C54D853-78E8-4DEC-B3BF-54DB2583B856","content":"\t}\n","styles":[],"attachments":[]},{"id":"66194112-D3BD-4DDE-A1FD-F448E90B5E56","content":"}\n","styles":[],"attachments":[]},{"id":"453BA0A7-A445-4924-848E-E9BA6D50B338","content":"\n","styles":[],"attachments":[]},{"id":"6DF39977-C240-45E4-8467-E41094C6F1FB","content":"\n","styles":[],"attachments":[]},{"id":"4666736F-14A2-4BC2-9BCC-A5BD35C118C9","content":"\n","styles":[],"attachments":[]},{"id":"2F961F33-8B94-4C76-B1E9-D6190E7E5FF3","content":"\n","styles":[],"attachments":[]},{"id":"F63C0DA0-749C-476B-AA17-90197BAEC505","content":"\n","styles":[],"attachments":[]},{"id":"36CFEEC2-1288-43EE-8137-ABE817C49A1F","content":"\n","styles":[],"attachments":[]},{"id":"8852476F-DDC7-4A31-BC37-4AAFD7FA20B3","content":"\n","styles":[],"attachments":[]},{"id":"D7C176EA-FF17-451D-A2F9-E1E5BE7171E4","content":"\n","styles":[],"attachments":[]},{"id":"072266EC-FE55-4328-B01E-F2448BE017E4","content":"\n","styles":[],"attachments":[]},{"id":"2205A37E-71BE-455F-ADEF-E966E3EF325C","content":"\n","styles":[],"attachments":[]},{"id":"DEFBF963-CA6F-44F3-87B1-AA1DC488A4C9","content":"\n","styles":[],"attachments":[]},{"id":"49F83A96-101B-4267-87BE-3FE7ECD772A7","content":"\n","styles":[],"attachments":[]},{"id":"B6A58518-22A4-46E6-BCA3-95F6AF50DA78","content":"\n","styles":[],"attachments":[]},{"id":"49B39449-9E45-4EE6-AA15-277E097E86D8","content":"\n","styles":[],"attachments":[]},{"id":"1EEB4628-EBB0-482B-871C-D9E940EE5B3E","content":"\n","styles":[],"attachments":[]},{"id":"893DEB80-DCFE-4BA2-8D6D-DD09919EC2F6","content":"\n","styles":[],"attachments":[]},{"id":"2AEB35A8-15F5-49DE-8905-0936BFD6E662","content":"\n","styles":[],"attachments":[]},{"id":"92536244-6472-4D0E-A43D-7D5A6CE681F5","content":"\n","styles":[],"attachments":[]},{"id":"B444F9E2-8111-462E-A92C-2DA72D422E66","content":"","styles":[],"attachments":[]}]}