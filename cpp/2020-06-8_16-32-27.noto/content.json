{"lines":[{"id":"EFC2987C-8CA0-4A41-9340-658042877632","content":"zero-copy & mmap\n","styles":[],"paragraphType":"title","attachments":[]},{"id":"5290875B-7D6C-4367-91CB-017DD89CE42C","content":"\n","styles":[],"attachments":[]},{"id":"DC6EC59A-7CF0-40A0-BA11-484F6F03CA0E","content":"\n","styles":[],"attachments":[]},{"id":"A739012F-BC00-44B8-8DD8-FE7639D47E28","content":"#### read-write\n","styles":[],"attachments":[]},{"id":"30043950-8E18-4590-97AF-134F41BCC49F","content":"￼\n","styles":[],"paragraphType":"body","attachments":[{"percentageWidth":0.42999999999999999,"type":"image","name":"mmap_1.jpg","location":0}]},{"id":"72387AD1-EDBF-4AFD-8328-E2F75F63325A","content":"￼\n","styles":[],"paragraphType":"body","attachments":[{"percentageWidth":0.625,"content":"cpp","caption":{"lines":[{"id":"08958D17-0C69-4819-A28D-736D0C570D0F","content":"read(file, tmp_buf, len);\n","styles":[],"attachments":[]},{"id":"62F7FC9C-2EF3-4863-8E7C-EF97A0194026","content":"write(socket, tmp_buf, len);","styles":[],"attachments":[]}]},"type":"code","name":"E1CB22C5-0274-4EE5-BD6D-194E45CA03C6. 2","location":0}]},{"id":"DA63DAF3-9BB1-481B-9EFD-13425E365A7B","content":"4次copy，2次用户态到内核态的切换\n","styles":[{"type":"bold","range":[0,19]}],"attachments":[]},{"id":"3617FAB6-27F4-4D46-ACBF-9F12F1081C3D","content":"\n","styles":[],"attachments":[]},{"id":"5177D060-9203-4312-A4FF-C85FCA6B8144","content":"\n","styles":[],"attachments":[]},{"id":"E2C45AF8-9B3D-4196-BF7F-7B4694717ACC","content":"#### mmap-write\n","styles":[],"attachments":[]},{"id":"10043750-8E18-4590-97AF-134F41BCC49F","content":"￼\n","styles":[],"paragraphType":"body","attachments":[{"percentageWidth":0.42999999999999999,"type":"image","name":"mmap_2.jpg","location":0}]},{"id":"494F81D6-FAE2-49DD-A9C8-B0D5383E896D","content":"￼\n","styles":[],"paragraphType":"body","attachments":[{"percentageWidth":0.625,"content":"cpp","caption":{"lines":[{"id":"C7DFDCDF-7391-4F7D-87B9-45666EEB5FA2","content":"tmp_buf = mmap(file, len);\n","styles":[],"attachments":[]},{"id":"00B59612-E267-4192-987D-EE0267007891","content":"write(socket, tmp_buf, len);","styles":[],"attachments":[]}]},"type":"code","name":"E1CB22C5-0274-4EE5-BD6D-194E45CA03C6.","location":0}]},{"id":"AEE1B8F7-18A8-4556-B9E4-4227D2F12097","content":"3次copy，2次switch\n","styles":[{"type":"bold","range":[0,15]}],"paragraphType":"body","attachments":[]},{"id":"F6D2D4AF-39A8-4751-B1AB-71F8D488B5BC","content":"执行细节\n","styles":[{"type":"bold","range":[0,4]}],"paragraphType":"body","attachments":[]},{"id":"720E9A85-7843-406E-919A-4E3EC8E666EF","content":"1>  first_copy，mmap()把文件内容读到kernel_buffer，这块内核buf和用户的tmp共享\n","styles":[],"attachments":[]},{"id":"C1991DE5-6C76-4F76-B2B0-D12AE56D27E2","content":"2>  second_copy，write()把数据copy到与socket关联的内核buffer\n","styles":[],"attachments":[]},{"id":"CC21BCF8-B304-416D-BBBD-020541D49F84","content":"3>  third_copy，DMA输出到网络硬件\n","styles":[],"attachments":[]},{"id":"7493F43B-DF4C-4D29-8691-93B8F3AE7B0B","content":"\n","styles":[],"attachments":[]},{"id":"66D783A5-DD1D-4C36-8640-C5ADD830D3B8","content":"\n","styles":[],"attachments":[]},{"id":"970173E4-3885-451C-B2A2-2AD9A26D53B2","content":"#### sendfile-1\n","styles":[],"attachments":[]},{"id":"B2FB3970-5CD0-4354-89B2-671C793CD01A","content":"￼\n","styles":[],"paragraphType":"body","attachments":[{"percentageWidth":0.42999999999999999,"type":"image","name":"mmap_3.jpg","location":0}]},{"id":"F1AE54CC-6AF8-43BF-A603-AE195429EF8B","content":"￼\n","styles":[],"paragraphType":"body","attachments":[{"percentageWidth":0.625,"content":"cpp","caption":{"lines":[{"id":"358B9E92-A23F-478B-A44E-E707C3D4CF68","content":"sendfile(socket, file, len);","styles":[],"attachments":[]}]},"type":"code","name":"E1CB22C5-0274-4EE5-BD6D-194E45CA03C6. 2 2","location":0}]},{"id":"888E4CC5-C561-4439-A30C-8D2CC157E756","content":"3次copy，1次switch\n","styles":[{"type":"bold","range":[0,16]}],"attachments":[]},{"id":"8F761F68-34C4-4353-94F9-299BC1774E3B","content":"\n","styles":[],"attachments":[]},{"id":"B5EBA13A-311E-443D-9AAC-7187AD9D55C6","content":"\n","styles":[],"attachments":[]},{"id":"7E789A8A-F8E0-4FE5-88D1-A8B8D472B9FC","content":"#### sendfile-2\n","styles":[],"attachments":[]},{"id":"30043911-8E18-4590-97AF-134F41BCC49F","content":"￼\n","styles":[],"paragraphType":"body","attachments":[{"percentageWidth":0.42999999999999999,"type":"image","name":"mmap_4.jpg","location":0}]},{"id":"4128BDA4-4B70-40A3-A1A9-76BC64D2FDB0","content":"2次copy，1次switch\n","styles":[{"type":"bold","range":[0,15]}],"attachments":[]},{"id":"87517CED-FCF5-4962-ADC9-4FD0BA4904D5","content":"第一步，依然是把文件内容copy到kernel_buffer\n","styles":[],"attachments":[]},{"id":"3E3AC8DB-C465-4483-B454-14AC85221C28","content":"第二步，不再copy到socket_buffer，仅追加描述符到socket_buffer\n","styles":[],"attachments":[]},{"id":"86A374FB-67BE-4C18-BE12-B4518DB72737","content":"\n","styles":[],"attachments":[]},{"id":"662782DF-BC19-42AC-A04C-9F3547BFF7A2","content":"\n","styles":[],"attachments":[]},{"id":"DB3466DC-AED7-41F1-A411-EA5793F3C1D3","content":"#### mmap VS read\n","styles":[],"attachments":[]},{"id":"6454980C-BF99-4DCC-AB6A-E34CD441FDE1","content":"mmap is not so good\n","styles":[],"attachments":[]},{"id":"B53425A0-6CC8-4B2F-BE1D-E4480124707E","content":"•\tA call to mmap(memory map) has more overhead than read just like epoll has more overhead than poll.\n","styles":[{"type":"bold","range":[33,56]}],"paragraphType":"body","attachments":[]},{"id":"9A7A7F4F-2274-4744-AF4F-7CE05861A3BA","content":"•\tThe IO system can already use the disk cache, so if you read a file, you'll hit the cache or miss it no matter what method you use.\n","styles":[{"type":"bold","range":[36,46]}],"paragraphType":"body","attachments":[]},{"id":"0A334E9A-95FF-4035-A43F-A414CA2955D6","content":"Advantages of mmap\n","styles":[],"attachments":[]},{"id":"A00F5A46-FBE7-4C47-A4A9-48E3A498A7C0","content":"•\tmmap are generally faster for random access, especially if your access patterns are sparse and unpredictable.\n","styles":[{"type":"bold","range":[21,45]}],"paragraphType":"body","attachments":[]},{"id":"454E8116-AE9C-4526-885B-A753D5171600","content":"•\tmmap allow you to keep using pages from the cache until you are done. This means that if you use a file heavily for a long period of time, then close it and reopen it, the pages will still be cached.\n","styles":[{"type":"bold","range":[20,36]}],"paragraphType":"body","attachments":[]},{"id":"A21E910E-9B65-4197-9DE6-4FF380121608","content":"Conclusion\n","styles":[{"type":"bold","range":[10,11]}],"paragraphType":"body","attachments":[]},{"id":"269E10F5-7593-4AE6-81D7-EBBEB677B2D6","content":"•\tUse mmap if you access data randomly, keep it around for a long time, or if you know you can share it with other processes.\n","styles":[],"paragraphType":"body","attachments":[]},{"id":"F457CA57-5510-4374-BF52-9DE3D79D0794","content":"•\tFor sequential access, both fread and ifstream are equally fast. Unbuffered IO (read) is slower, as expected. Memory mapping is not beneficial.\n","styles":[],"paragraphType":"body","attachments":[]},{"id":"13871C40-5B0A-41ED-B2CE-EBC2BCC9DB19","content":"Perf\n","styles":[],"attachments":[]},{"id":"B1CCC2A7-E03B-4450-B121-2494AFEC5D6A","content":"•\t1G文件，read\/write copy用时3200ms，mmap copy用时800ms\n","styles":[],"attachments":[]},{"id":"033C4EE3-6488-4AB0-98DE-CB08E4AB39F5","content":"\n","styles":[],"attachments":[]},{"id":"8CF194A6-93E3-4AC8-B8FA-EB19ADBBF9FC","content":"\n","styles":[],"attachments":[]},{"id":"E910A44A-2403-49EC-AF14-14C614E5D8C4","content":"\n","styles":[],"attachments":[]},{"id":"916072D2-4B3A-4404-BF55-168749B2B517","content":"\n","styles":[],"attachments":[]},{"id":"DB119FDB-8D24-4BA8-92E6-9DC70565AF66","content":"\n","styles":[],"attachments":[]},{"id":"BDC3E0CC-2B91-4C05-85BC-9B57A4767397","content":"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ","styles":[],"attachments":[]}]}